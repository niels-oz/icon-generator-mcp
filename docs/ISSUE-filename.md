# CRITICAL ISSUE: Filename Generation Broken Since v0.4.0

## Problem Summary

The filename generation logic is completely broken in v0.4.0+ and produces terrible filenames like:
- `create-a-beautiful-minimalist-.svg` (with trailing dash)
- `create-a-user-profile-icon-in-.svg` (30-char truncation)

This was NOT a problem in v0.3.x which generated clean semantic filenames.

## Root Cause Analysis

### v0.3.x Working Architecture (GOOD)
```typescript
// In v0.3.x, LLM service returned both fields:
interface LLMResponse {
  svg: string;
  filename: string;  // ← LLM generated semantic names
}

// Usage in generation phase:
const llmResponse = await this.llmService.generate(prompt, references, style);
this.stateManager.updateContext(sessionId, { 
  generatedSvg: llmResponse.svg,
  suggestedFilename: llmResponse.filename  // ← Clean semantic name
});

// Examples of v0.3.x filenames:
// "user-profile-icon"
// "star-icon" 
// "home-icon"
```

### v0.4.0+ Broken Architecture (BAD)
```typescript
// v0.4.0 removed LLM service and introduced broken logic:
private generateFilename(prompt: string): string {
  return prompt.toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .replace(/\s+/g, '-')
    .substring(0, 30) || 'generated-icon';  // ← BROKEN: Truncates with trailing dash
}

// This produces garbage like:
// "create-a-beautiful-minimalist-" (truncated at 30 chars)
// "create-a-user-profile-icon-in-" (ends with dash)
```

## The Missing Piece

**The v0.3.x LLM service was responsible for generating BOTH the SVG content AND semantic filenames.**

The filename wasn't generated by string processing the prompt - it was an intelligent byproduct of the LLM understanding what to generate.

## Current Status (v0.4.3)

### What We Fixed
- ✅ Updated `generateSimpleSVG()` to return `{svg, filename}` like v0.3.x
- ✅ Added keyword extraction instead of broken 30-char truncation
- ✅ Removed hardcoded cases (star, dog, user, etc.) - that was the wrong approach

### What's Still Broken
- ❌ **MCP server still uses old broken logic** - the fix isn't reaching execution
- ❌ Test with long prompt still produces `create-a-beautiful-minimalist-.svg`
- ❌ Something in the binary or cached code is using the old `generateFilename()` method

## Technical Investigation Needed

### 1. Verify Code Path
The published npm package might still be using old logic. Check:
```bash
# Test current npm package
npm install -g icon-generator-mcp@0.4.3
echo '{"jsonrpc": "2.0", "id": 1, "method": "tools/call", "params": {"name": "generate_icon", "arguments": {"prompt": "Create a beautiful minimalist dog icon"}}}' | icon-generator-mcp
```

Expected result: Clean filename like `dog-silhouette-icon.svg`
Actual result: Broken `create-a-beautiful-minimalist-.svg`

### 2. Find Remaining Broken Code
The fix should have made this work, but something is still calling the old broken logic. Possible locations:
- Old cached binary in `/opt/homebrew/bin/icon-generator-mcp`
- Remaining `generateFilename()` method calls in the codebase
- MCP server transport layer using different code path

### 3. Git History Reference
The working filename logic existed in commit `cd9716d` and earlier:
```typescript
// v0.3.x approach - LLM service generated both fields
const llmResponse = await this.llmService.generate(prompt, references, style);
suggestedFilename: llmResponse.filename
```

## Expected Final Solution

The `generateSimpleSVG()` method should work like the original LLM service:
```typescript
private generateSimpleSVG(prompt: string, references: string[]): {svg: string, filename: string} {
  // Extract 1-2 meaningful keywords
  const keywords = prompt.toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .split(/\s+/)
    .filter(word => word.length > 2 && !stopWords.includes(word))
    .slice(0, 2)
    .join('-');
  
  return {
    svg: generateSVGContent(prompt, references),
    filename: keywords || 'generated-icon'
  };
}
```

**Test Cases:**
- "Create a beautiful minimalist dog icon" → `dog-minimalist` or `dog-icon`
- "User profile silhouette" → `user-profile`
- "Star shape" → `star-shape`

## Priority: CRITICAL
This affects user experience significantly. Clean filenames are essential for a professional tool.

## Next Steps for Developer
1. Find why the fix isn't working (code path investigation)
2. Ensure complete removal of old `generateFilename()` logic
3. Test with long prompts to verify semantic filename extraction
4. Publish working version as v0.4.4